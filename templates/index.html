<!DOCTYPE html>
<html lang="en">

  <head>
    <title>Bootstrap 5 Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>

    <div
      class="container-fluid pt-2 pb-1 bg-dark text-white text-center sticky-top border-bottom border-3 border-warning">
      <h1 class="text-warning">DevOps</h1>
      <p>Robart Test (Github Repsitory Search)</p>
    </div>

    <div class="container-fluid mt-2 px-4">
      <div class="row">
        <div class="col-sm-4  p-1 container">
          <div class="d-flex flex-column border border-2 border-dark" style="position: fixed;height: 80vh; width: 30%;">
            <div class="py-1 container text-center bg-dark">
              <h2 class="text-warning">Search</h2>
            </div>
            <div class="container mt-2  text-left">
              <label style="font-size: 14px;">USER / ORG:</label>
            </div>
            <div class="container">
              <input id="searchInput" class="form-control w-100" style="font-size: 12px;" type="text"
                placeholder="eg. khaleddallah, facebook" name="user">
            </div>
            <div class="container text-center mt-4">
              <button id="searchButton" type="button" class="btn btn-dark px-2 w-100"
                onclick="SendReq()">Search</button>
            </div>
            <br>
            <div id="spiner" class="text-center">
              <div class="spinner-border" role="status">
                <span class="sr-only"></span>
              </div>
            </div>
          </div>
        </div>



        <div class="col-sm-offset-4 col-sm-8">
          <div class="container">
            <h6 id="noresult" class="pt-5 text-muted"> No results ...</h6>
          </div>
          <div id="cards">

            <div class="card  border-warning my-3 border-3" style="width: 100%;background-color: rgb(31, 31, 31);">
              <div class="card-header text-warning" style="background-color: rgb(33, 33, 33);">

                <h5 class=" name card-title ">...</h5>
                <h6 style=" display: inline;color:rgba(207, 158, 80, 0.912);">#</h6>
                <h6 style="display: inline;color:rgba(207, 158, 80, 0.912);" class="language card-subtitle mb-2">
                  ...</h6>
              </div>
              <div class="card-body text-light " style="background-color: rgb(43, 43, 43); border:rgb(33, 33, 33)">
                <div class="row">
                  <div class="col text-center ">
                    <span style="font-size: 12px;">CREATED_AT</span>
                    <br>
                    <span class="created_at fw-bold text-warning" style="font-size: 16px;">...</span>
                  </div>
                  <div class="col text-center ">
                    <span style="font-size: 12px;">PUSHED_AT</span>
                    <br>
                    <span class="pushed_at fw-bold text-warning" style="font-size: 16px;">...</span>
                  </div>
                  <div class="col text-center">
                    <span style="font-size: 12px;">UPDATED_AT</span>
                    <br>
                    <span class="updated_at fw-bold text-warning" style="font-size: 16px;">...</span>
                  </div>
                  <!-- </div> -->
                  <!-- <div class="row pt-4 pb-1"> -->

                  <div class="col text-center ">
                    <span style="font-size: 12px;">WATCHERS</span>
                    <br>
                    <span class="watchers fw-bold text-warning" style="font-size: 20px;">...</span>
                  </div>
                  <div class="col text-center ">
                    <span style="font-size: 12px;">STARS</span>
                    <br>
                    <span class="stars fw-bold text-warning" style="font-size: 20px;">...</span>
                  </div>
                  <div class="col text-center">
                    <span style="font-size: 12px;">FORKS</span>
                    <br>
                    <span class=" forks fw-bold text-warning" style="font-size: 20px;">...</span>
                  </div>
                  <div class="col text-center">
                    <span style="font-size: 12px;">ISSUES</span>
                    <br>
                    <span class="issues fw-bold text-warning" style="font-size: 20px;">...</span>
                  </div>
                </div>
              </div>

            </div>

          </div>
        </div>
      </div>
    </div>

  </body>

  <script>

    document.addEventListener('DOMContentLoaded', (event) => {
      document.getElementById("spiner").style.display = "none";
      document.getElementById("cards").firstElementChild.style.display = "none";
    });

    document.addEventListener("keyup", function (e) {
      if (e.code === 'Enter') {
        SendReq();
      }
    });

    function SendReq() {
      searchInput = document.getElementById("searchInput").value;
      console.log(searchInput);
      console.log(searchInput.length);
      if (searchInput.length == 0) {
        alert("Please enter a user or org name");
        return;
      }
      else {
        var spinner = document.getElementById("spiner");
        spinner.style.display = "block";
        var searchButton = document.getElementById("searchButton");
        searchButton.disabled = true;

        var xhr = new XMLHttpRequest();
        xhr.responseType = 'json';
        xhr.open("POST", '/test', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({
          value: document.getElementById("searchInput").value
        }));

        xhr.upload.onprogress = function (event) {
          console.log(`Uploaded ${event.loaded} of ${event.total}`);
        };

        xhr.onload = function () {
          document.getElementById("noresult").style.display = "none";
          spinner.style.display = "none";
          searchButton.disabled = false;
          if (xhr.status != 200) { // analyze HTTP status of the response
            alert(`Error ${xhr.status}: ${xhr.statusText}`); // e.g. 404: Not Found
            document.getElementById("noresult").style.display = "block";
          } else { // show the result
            console.log(xhr.response);
            console.log(xhr.response["data"].length);
            repos = xhr.response["data"];
            var cardParent = document.getElementById("cards");
            var card = cardParent.firstElementChild;
            card.style.display = "none";

            //clear the cards
            let cardsCount = cardParent.children.length;
            for (let i = 1; i < cardsCount; i++) {
              cardParent.children[1].remove();
            }

            // Add new cards
            for (var repo in repos) {
              console.log(repos[repo]);
              var clone = card.cloneNode(true); // "deep" clone
              clone.style.display = "block";
              cardParent.appendChild(clone);
              clone.getElementsByClassName("name")[0].innerHTML = repos[repo]["name"];
              clone.getElementsByClassName("language")[0].innerHTML = repos[repo]["primaryLanguage"] ? repos[repo]["primaryLanguage"]["name"] : "No language";
              clone.getElementsByClassName("created_at")[0].innerHTML = repos[repo]["createdAt"].substring(0, 10);
              clone.getElementsByClassName("pushed_at")[0].innerHTML = repos[repo]["pushedAt"].substring(0, 10);
              clone.getElementsByClassName("updated_at")[0].innerHTML = repos[repo]["updatedAt"].substring(0, 10);
              clone.getElementsByClassName("watchers")[0].innerHTML = repos[repo]["watchers"]["totalCount"];
              clone.getElementsByClassName("stars")[0].innerHTML = repos[repo]["stargazerCount"];
              clone.getElementsByClassName("forks")[0].innerHTML = repos[repo]["forkCount"];
              clone.getElementsByClassName("issues")[0].innerHTML = repos[repo]["issues"]["totalCount"];

            }
          }
        };

      }
    }
  </script>

</html>